name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: package-release-files
        shell: bash
        run: |
          set -euo pipefail

          version="${GITHUB_REF_NAME:-dev-${GITHUB_SHA::7}}"
          archive_name="pesdekery-${version}.tar.gz"

          mkdir -p dist
          tar -czf "dist/${archive_name}" \
            pesde.toml \
            README.md \
            src \
            architectures

          sha256sum "dist/${archive_name}" > "dist/${archive_name}.sha256"

      - name: upload-artifact
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/*

      - name: publish-release
        if: ${{ startsWith(github.ref, 'refs/tags/') && env.ACT != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
          generate_release_notes: true
          fail_on_unmatched_files: true
